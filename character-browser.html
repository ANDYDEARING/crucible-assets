<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Synty SciFi Horror - Character Browser</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0a0a0f;
    color: #e0e0e0;
    min-height: 100vh;
  }
  header {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    padding: 20px 30px;
    border-bottom: 2px solid #e94560;
    display: flex;
    align-items: center;
    gap: 20px;
  }
  header h1 { font-size: 24px; color: #fff; }
  header h1 span { color: #e94560; }

  .layout {
    display: flex;
    height: calc(100vh - 72px);
  }

  /* Sidebar */
  .sidebar {
    width: 320px;
    min-width: 320px;
    background: #111;
    border-right: 1px solid #333;
    overflow-y: auto;
    padding: 16px;
  }
  .sidebar h2 {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #888;
    margin-bottom: 12px;
  }
  .filter-group { margin-bottom: 20px; }
  .filter-group label {
    display: block;
    font-size: 12px;
    color: #999;
    margin-bottom: 6px;
  }
  .filter-group select, .filter-group input {
    width: 100%;
    padding: 8px 10px;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 4px;
    color: #e0e0e0;
    font-size: 13px;
  }

  .char-list { list-style: none; }
  .char-list li {
    padding: 12px 14px;
    margin-bottom: 4px;
    border-radius: 6px;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s;
  }
  .char-list li:hover { background: #1a1a2e; border-color: #333; }
  .char-list li.active { background: #1a1a2e; border-color: #e94560; }
  .char-list li .char-name { font-size: 14px; font-weight: 600; display: block; }
  .char-list li .char-type {
    font-size: 11px;
    color: #888;
    margin-top: 2px;
    display: block;
  }
  .char-list li .char-tags {
    display: flex;
    gap: 4px;
    margin-top: 6px;
    flex-wrap: wrap;
  }
  .tag {
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: 500;
  }
  .tag-crew { background: #1a3a1a; color: #4ade80; }
  .tag-suit { background: #1a2a3a; color: #60a5fa; }
  .tag-alien { background: #3a1a3a; color: #c084fc; }
  .tag-android { background: #3a2a1a; color: #fb923c; }
  .tag-mining { background: #3a3a1a; color: #facc15; }
  .tag-dead { background: #3a1a1a; color: #f87171; }
  .tag-creature { background: #2a1a2a; color: #e879f9; }
  .tag-male { background: #1a2a3a; color: #93c5fd; }
  .tag-female { background: #2a1a2a; color: #f9a8d4; }

  /* Main content */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  /* 3D Viewer */
  .viewer-container {
    flex: 1;
    position: relative;
    background: #0d0d1a;
    background-image:
      radial-gradient(circle at 50% 50%, #1a1a2e 0%, transparent 70%);
  }
  #viewer-canvas {
    width: 100%;
    height: 100%;
    display: block;
  }
  .viewer-controls {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    background: rgba(0,0,0,0.7);
    padding: 8px 16px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
  }
  .viewer-controls button {
    background: #222;
    border: 1px solid #444;
    color: #fff;
    padding: 6px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.15s;
  }
  .viewer-controls button:hover { background: #e94560; border-color: #e94560; }
  .viewer-controls button.active { background: #e94560; border-color: #e94560; }

  .loading-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(10,10,15,0.85);
    z-index: 10;
  }
  .loading-overlay.hidden { display: none; }
  .spinner {
    width: 40px; height: 40px;
    border: 3px solid #333;
    border-top-color: #e94560;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Detail panel */
  .detail-panel {
    background: #111;
    border-top: 1px solid #333;
    padding: 20px 24px;
    min-height: 200px;
    max-height: 280px;
    overflow-y: auto;
  }
  .detail-panel h2 { font-size: 18px; margin-bottom: 12px; color: #fff; }
  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
  }
  .detail-section h3 {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #888;
    margin-bottom: 8px;
  }
  .detail-section p { font-size: 13px; line-height: 1.6; }

  .texture-swatches {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  .swatch {
    width: 48px;
    height: 48px;
    border-radius: 4px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.15s;
    background-size: cover;
    background-position: center;
  }
  .swatch:hover { border-color: #fff; transform: scale(1.1); }
  .swatch.active { border-color: #e94560; }
  .swatch-label {
    font-size: 10px;
    text-align: center;
    color: #888;
    margin-top: 2px;
  }

  .mesh-list {
    list-style: none;
    font-size: 12px;
  }
  .mesh-list li {
    padding: 3px 0;
    color: #aaa;
    font-family: 'SF Mono', Monaco, monospace;
  }
  .mesh-list li::before {
    content: ">";
    color: #e94560;
    margin-right: 6px;
  }

  .no-selection {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #555;
    gap: 12px;
  }
  .no-selection svg { width: 64px; height: 64px; opacity: 0.3; }
  .no-selection p { font-size: 14px; }

  /* Color variant bar */
  .color-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 24px;
    background: #0f0f1a;
    border-top: 1px solid #222;
  }
  .color-bar label {
    font-size: 12px;
    color: #888;
    white-space: nowrap;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #555; }
</style>
</head>
<body>

<header>
  <h1>Polygon <span>SciFi Horror</span> - Character Browser</h1>
</header>

<div class="layout">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="filter-group">
      <label>Filter by Category</label>
      <select id="categoryFilter">
        <option value="all">All Characters</option>
        <option value="crew">Crew Members</option>
        <option value="spacesuit">Space Suits</option>
        <option value="mining">Mining Suit</option>
        <option value="alien">Aliens</option>
        <option value="android">Android</option>
        <option value="creature">Creatures</option>
        <option value="dead">Dead Variants</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Search</label>
      <input type="text" id="searchInput" placeholder="Type to filter...">
    </div>

    <h2>Characters</h2>
    <ul class="char-list" id="charList"></ul>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="viewer-container" id="viewerContainer">
      <canvas id="viewer-canvas"></canvas>
      <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
      </div>
      <div class="no-selection" id="noSelection">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
        </svg>
        <p>Select a character from the left panel to preview</p>
      </div>
      <div class="viewer-controls" id="viewerControls" style="display:none;">
        <button onclick="resetCamera()">Reset View</button>
        <button onclick="toggleWireframe()" id="wireframeBtn">Wireframe</button>
        <button onclick="toggleRotation()" id="rotateBtn">Auto Rotate</button>
      </div>
    </div>

    <div class="color-bar" id="colorBar">
      <label>Color Palette:</label>
      <div class="texture-swatches" id="textureSwatches"></div>
    </div>

    <div class="detail-panel" id="detailPanel">
      <div class="no-selection" style="height:100%">
        <p>Character details will appear here</p>
      </div>
    </div>
  </div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

// Base path to SciFiHorror assets (relative to where this HTML file lives)
const ASSET_BASE = 'synty/SourceFiles/SciFiHorror/';

// Character data
const characters = [
  {
    id: 'alien_01',
    name: 'Alien',
    category: 'alien',
    gender: null,
    description: 'Xenomorph-like alien creature. Uses the shiny dark material variant (04_C). Standalone alien body model.',
    fbx: 'FBX/Characters/Attachments/SM_Chr_Attach_Alien_01.fbx',
    meshes: ['SM_Chr_Alien_01'],
    material: 'PolygonSciFiHorror_04_A_Shiny',
    tags: ['alien', 'creature'],
    defaultHead: null,
    accessories: []
  },
  {
    id: 'android_01',
    name: 'Android',
    category: 'android',
    gender: null,
    description: 'Humanoid android character with a synthetic head (Head_08). Robotic body with mechanical features visible under the outer shell.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Android_01',
    meshes: ['SM_Chr_Android_01', 'SM_Chr_Attach_Head_08'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['android'],
    defaultHead: 'Head_08',
    accessories: ['Head_08']
  },
  {
    id: 'crew_01_f',
    name: 'Crew Member 01 (Female)',
    category: 'crew',
    gender: 'female',
    description: 'Female crew member with ponytail hairstyle. Standard issue uniform. Can swap to different hair styles or add helmets.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Crew_01_F',
    meshes: ['SM_Chr_Crew_01_F', 'SM_Chr_Attach_Hair_Ponytail_01', 'SM_Chr_Attach_Hair_01'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['crew', 'female'],
    defaultHead: 'Hair_Ponytail_01',
    accessories: ['Hair_01', 'Hair_Ponytail_01']
  },
  {
    id: 'crew_01_m',
    name: 'Crew Member 01 (Male)',
    category: 'crew',
    gender: 'male',
    description: 'Male crew member with short styled hair (Hair_03). Standard issue uniform.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Crew_01_M',
    meshes: ['SM_Chr_Crew_01_M', 'SM_Chr_Attach_Hair_03'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['crew', 'male'],
    defaultHead: 'Hair_03',
    accessories: ['Hair_03']
  },
  {
    id: 'crew_02_f',
    name: 'Crew Member 02 (Female)',
    category: 'crew',
    gender: 'female',
    description: 'Female crew member with cap/hat. Different uniform variant from Crew 01.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Crew_02_F',
    meshes: ['SM_Chr_Crew_02_F', 'SM_Chr_Attach_Hat_02_F'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['crew', 'female'],
    defaultHead: 'Hat_02_F',
    accessories: ['Hat_02_F']
  },
  {
    id: 'crew_02_m',
    name: 'Crew Member 02 (Male)',
    category: 'crew',
    gender: 'male',
    description: 'Male crew member with cap/hat. Different uniform variant from Crew 01.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Crew_02_M',
    meshes: ['SM_Chr_Crew_02_M', 'SM_Chr_Attach_Hat_02_M'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['crew', 'male'],
    defaultHead: 'Hat_02_M',
    accessories: ['Hat_02_M']
  },
  {
    id: 'crew_03_f',
    name: 'Crew Member 03 (Female)',
    category: 'crew',
    gender: 'female',
    description: 'Female crew member with long voluminous hair (Hair_05). Third uniform variant.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Crew_03_F',
    meshes: ['SM_Chr_Crew_03_F', 'SM_Chr_Attach_Hair_05'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['crew', 'female'],
    defaultHead: 'Hair_05',
    accessories: ['Hair_05']
  },
  {
    id: 'crew_03_m',
    name: 'Crew Member 03 (Male)',
    category: 'crew',
    gender: 'male',
    description: 'Male crew member with shorter hair (Hair_04). Third uniform variant.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Crew_03_M',
    meshes: ['SM_Chr_Crew_03_M', 'SM_Chr_Attach_Hair_04'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['crew', 'male'],
    defaultHead: 'Hair_04',
    accessories: ['Hair_04']
  },
  {
    id: 'mining_suit_01',
    name: 'Mining Suit',
    category: 'mining',
    gender: null,
    description: 'Heavy-duty mining suit with visor attachment. Uses Head_01. The suit itself uses the standard material while the alien body underneath uses the shiny dark variant.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Mining_Suit_01',
    meshes: ['SM_Chr_Mining_Suit_01', 'SM_Chr_Attach_Mining_Suit_Visor_01', 'SM_Chr_Attach_Head_01'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['mining'],
    defaultHead: 'Head_01',
    accessories: ['Mining_Suit_Visor_01', 'Head_01']
  },
  {
    id: 'space_suit_01_f',
    name: 'Space Suit 01 (Female)',
    category: 'spacesuit',
    gender: 'female',
    description: 'Female space suit with Helmet 01 (rounded dome). Hair_01 visible through the glass visor. Full EVA-ready design.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Space_Suit_01_F',
    meshes: ['SM_Chr_Space_Suit_01_F', 'SM_Chr_Attach_Helmet_01', 'SM_Chr_Attach_Helmet_01_Glass', 'SM_Chr_Attach_Hair_01'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['suit', 'female'],
    defaultHead: 'Helmet_01',
    accessories: ['Helmet_01', 'Hair_01']
  },
  {
    id: 'space_suit_01_m',
    name: 'Space Suit 01 (Male)',
    category: 'spacesuit',
    gender: 'male',
    description: 'Male space suit with Helmet 01 (rounded dome). Hair_02 visible through the glass visor. Full EVA-ready design.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Space_Suit_01_M',
    meshes: ['SM_Chr_Space_Suit_01_M', 'SM_Chr_Attach_Helmet_01', 'SM_Chr_Attach_Helmet_01_Glass', 'SM_Chr_Attach_Hair_02'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['suit', 'male'],
    defaultHead: 'Helmet_01',
    accessories: ['Helmet_01', 'Hair_02']
  },
  {
    id: 'space_suit_01_f_dead',
    name: 'Space Suit 01 Dead (Female)',
    category: 'dead',
    gender: 'female',
    description: 'Dead female crew member in Space Suit 01. Broken helmet with cracks. Head_04 (horror/death face). Perfect for environmental storytelling or horror set pieces.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Space_Suit_01_F_Dead',
    meshes: ['SM_Chr_Space_Suit_01_F_Dead', 'SM_Chr_Attach_Head_04', 'SM_Chr_Attach_Helmet_01_Broken', 'SM_Chr_Attach_Helmet_01_Broken_Glass'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['suit', 'female', 'dead'],
    defaultHead: 'Head_04',
    accessories: ['Helmet_01_Broken', 'Head_04']
  },
  {
    id: 'space_suit_01_m_dead',
    name: 'Space Suit 01 Dead (Male)',
    category: 'dead',
    gender: 'male',
    description: 'Dead male crew member in Space Suit 01. Broken helmet with cracks. Head_05 (horror/death face). Environmental storytelling prop.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Space_Suit_01_M_Dead',
    meshes: ['SM_Chr_Space_Suit_01_M_Dead', 'SM_Chr_Attach_Head_05', 'SM_Chr_Attach_Helmet_01_Broken', 'SM_Chr_Attach_Helmet_01_Broken_Glass'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['suit', 'male', 'dead'],
    defaultHead: 'Head_05',
    accessories: ['Helmet_01_Broken', 'Head_05']
  },
  {
    id: 'space_suit_02_f',
    name: 'Space Suit 02 (Female)',
    category: 'spacesuit',
    gender: 'female',
    description: 'Female space suit with Helmet 02 (angular/tactical design). Hair_01 visible through visor. Different suit silhouette from Suit 01.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Space_Suit_02_F',
    meshes: ['SM_Chr_Space_Suit_02_F', 'SM_Chr_Attach_Helmet_02', 'SM_Chr_Attach_Helmet_02_Glass', 'SM_Chr_Attach_Hair_01'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['suit', 'female'],
    defaultHead: 'Helmet_02',
    accessories: ['Helmet_02', 'Hair_01']
  },
  {
    id: 'space_suit_02_m',
    name: 'Space Suit 02 (Male)',
    category: 'spacesuit',
    gender: 'male',
    description: 'Male space suit with Helmet 02 (angular/tactical design). Hair_02 visible through visor. Different suit silhouette from Suit 01.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Space_Suit_02_M',
    meshes: ['SM_Chr_Space_Suit_02_M', 'SM_Chr_Attach_Helmet_02', 'SM_Chr_Attach_Helmet_02_Glass', 'SM_Chr_Attach_Hair_02'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['suit', 'male'],
    defaultHead: 'Helmet_02',
    accessories: ['Helmet_02', 'Hair_02']
  },
  {
    id: 'space_suit_02_f_dead',
    name: 'Space Suit 02 Dead (Female)',
    category: 'dead',
    gender: 'female',
    description: 'Dead female in Space Suit 02. Cracked Helmet 02 with Head_05 (death face). Horror environmental prop.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Space_Suit_02_F_Dead',
    meshes: ['SM_Chr_Space_Suit_02_F_Dead', 'SM_Chr_Attach_Head_05', 'SM_Chr_Attach_Helmet_02_Broken', 'SM_Chr_Attach_Helmet_02_Broken_Glass'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['suit', 'female', 'dead'],
    defaultHead: 'Head_05',
    accessories: ['Helmet_02_Broken', 'Head_05']
  },
  {
    id: 'space_suit_02_m_dead',
    name: 'Space Suit 02 Dead (Male)',
    category: 'dead',
    gender: 'male',
    description: 'Dead male in Space Suit 02. Cracked Helmet 02 with Head_04 (death face). Horror environmental prop.',
    fbx: 'FBX/Characters/PolygonSciFiHorror_Characters_01.fbx',
    meshName: 'SM_Chr_Space_Suit_02_M_Dead',
    meshes: ['SM_Chr_Space_Suit_02_M_Dead', 'SM_Chr_Attach_Head_04', 'SM_Chr_Attach_Helmet_02_Broken', 'SM_Chr_Attach_Helmet_02_Broken_Glass'],
    material: 'PolygonSciFiHorror_01_A',
    tags: ['suit', 'male', 'dead'],
    defaultHead: 'Head_04',
    accessories: ['Helmet_02_Broken', 'Head_04']
  },
  {
    id: 'zub_01',
    name: 'Zub (Creature)',
    category: 'creature',
    gender: null,
    description: 'Small alien creature / pet. Uses the shiny dark material (04_C_Shiny). Standalone model - separate FBX file.',
    fbx: 'FBX/Characters/SM_Chr_Zub_01.fbx',
    meshes: ['SM_Chr_Zub_01'],
    material: 'PolygonSciFiHorror_04_C_Shiny',
    tags: ['creature'],
    defaultHead: null,
    accessories: []
  }
];

// Texture palette data
const palettes = [
  { id: '01_A', label: '01-A', file: 'Textures/Alts/PolygonSciFiHorror_01_A.png', desc: 'Orange/Grey (Default)' },
  { id: '01_B', label: '01-B', file: 'Textures/Alts/PolygonSciFiHorror_01_B.png', desc: 'Blue/Grey' },
  { id: '01_C', label: '01-C', file: 'Textures/Alts/PolygonSciFiHorror_01_C.png', desc: 'Green/Grey' },
  { id: '02_A', label: '02-A', file: 'Textures/Alts/PolygonSciFiHorror_02_A.png', desc: 'Alt Orange' },
  { id: '02_B', label: '02-B', file: 'Textures/Alts/PolygonSciFiHorror_02_B.png', desc: 'Alt Blue' },
  { id: '02_C', label: '02-C', file: 'Textures/Alts/PolygonSciFiHorror_02_C.png', desc: 'Alt Green' },
  { id: '03_A', label: '03-A', file: 'Textures/Alts/PolygonSciFiHorror_03_A.png', desc: 'Variant 3A' },
  { id: '03_B', label: '03-B', file: 'Textures/Alts/PolygonSciFiHorror_03_B.png', desc: 'Variant 3B' },
  { id: '03_C', label: '03-C', file: 'Textures/Alts/PolygonSciFiHorror_03_C.png', desc: 'Variant 3C' },
  { id: '04_A', label: '04-A', file: 'Textures/Alts/PolygonSciFiHorror_04_A.png', desc: 'Dark Variant A' },
  { id: '04_B', label: '04-B', file: 'Textures/Alts/PolygonSciFiHorror_04_B.png', desc: 'Dark Variant B' },
  { id: '04_C', label: '04-C', file: 'Textures/Alts/PolygonSciFiHorror_04_C.png', desc: 'Dark Variant C' },
];

// State
let scene, camera, renderer, controls, currentModel;
let autoRotate = true;
let wireframe = false;
let selectedChar = null;
let currentPalette = palettes[0];
let textureCache = {};

// Initialize Three.js
function initViewer() {
  const canvas = document.getElementById('viewer-canvas');
  const container = document.getElementById('viewerContainer');

  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
  camera.position.set(0, 1.2, 3);

  renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.2;

  controls = new OrbitControls(camera, canvas);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.target.set(0, 0.8, 0);
  controls.autoRotate = true;
  controls.autoRotateSpeed = 2;
  controls.update();

  // Lighting
  const ambient = new THREE.AmbientLight(0x404060, 1.5);
  scene.add(ambient);

  const key = new THREE.DirectionalLight(0xffeedd, 2);
  key.position.set(3, 5, 3);
  scene.add(key);

  const fill = new THREE.DirectionalLight(0x4466aa, 0.8);
  fill.position.set(-3, 2, -1);
  scene.add(fill);

  const rim = new THREE.DirectionalLight(0xe94560, 0.6);
  rim.position.set(0, 3, -4);
  scene.add(rim);

  // Ground grid
  const grid = new THREE.GridHelper(10, 20, 0x333333, 0x1a1a1a);
  scene.add(grid);

  // Resize
  window.addEventListener('resize', () => {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
  });

  animate();
}

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}

// Load texture
function loadTexture(path) {
  return new Promise((resolve) => {
    if (textureCache[path]) {
      resolve(textureCache[path]);
      return;
    }
    const loader = new THREE.TextureLoader();
    loader.load(path, (tex) => {
      tex.flipY = false;
      tex.colorSpace = THREE.SRGBColorSpace;
      textureCache[path] = tex;
      resolve(tex);
    }, undefined, () => {
      // Try without flipY
      loader.load(path, (tex) => {
        tex.colorSpace = THREE.SRGBColorSpace;
        textureCache[path + '_flipped'] = tex;
        resolve(tex);
      });
    });
  });
}

// Load character model
async function loadCharacter(char) {
  const overlay = document.getElementById('loadingOverlay');
  const noSel = document.getElementById('noSelection');
  const viewerControls = document.getElementById('viewerControls');

  overlay.classList.remove('hidden');
  noSel.style.display = 'none';
  viewerControls.style.display = 'flex';

  // Remove old model
  if (currentModel) {
    scene.remove(currentModel);
    currentModel = null;
  }

  const loader = new FBXLoader();
  const tex = await loadTexture(ASSET_BASE + currentPalette.file);

  return new Promise((resolve) => {
    loader.load(ASSET_BASE + char.fbx, (fbx) => {
      // Scale down - Synty FBX are typically in cm
      fbx.scale.setScalar(0.01);

      // If it's the main characters file, we need to show only the relevant meshes
      if (char.fbx.includes('Characters_01.fbx') || char.fbx.includes('BR_Characters')) {
        fbx.traverse((child) => {
          if (child.isMesh) {
            const name = child.name;
            const shouldShow = char.meshes.some(m => name === m || name.startsWith(m));
            child.visible = shouldShow;

            if (shouldShow) {
              applyTextureToMesh(child, tex, char);
            }
          }
        });
      } else {
        // Standalone FBX - show everything
        fbx.traverse((child) => {
          if (child.isMesh) {
            applyTextureToMesh(child, tex, char);
          }
        });
      }

      scene.add(fbx);
      currentModel = fbx;

      // Auto-frame the model
      const box = new THREE.Box3().setFromObject(fbx);
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());

      // Only consider visible meshes for bounding
      const visibleBox = new THREE.Box3();
      fbx.traverse((child) => {
        if (child.isMesh && child.visible) {
          visibleBox.expandByObject(child);
        }
      });

      if (!visibleBox.isEmpty()) {
        const vCenter = visibleBox.getCenter(new THREE.Vector3());
        const vSize = visibleBox.getSize(new THREE.Vector3());
        controls.target.copy(vCenter);
        const maxDim = Math.max(vSize.x, vSize.y, vSize.z);
        camera.position.set(vCenter.x + maxDim * 1.2, vCenter.y + maxDim * 0.3, vCenter.z + maxDim * 1.2);
      }

      controls.update();
      overlay.classList.add('hidden');
      resolve();
    }, undefined, (err) => {
      console.error('Failed to load FBX:', err);
      overlay.classList.add('hidden');
    });
  });
}

function applyTextureToMesh(mesh, tex, char) {
  const isGlass = mesh.name.toLowerCase().includes('glass');
  const isShiny = char.material && char.material.includes('Shiny');

  if (isGlass) {
    mesh.material = new THREE.MeshPhysicalMaterial({
      map: tex,
      transparent: true,
      opacity: 0.3,
      roughness: 0.1,
      metalness: 0.5,
      transmission: 0.7,
      side: THREE.DoubleSide,
    });
  } else if (isShiny) {
    mesh.material = new THREE.MeshStandardMaterial({
      map: tex,
      roughness: 0.2,
      metalness: 0.8,
    });
  } else {
    mesh.material = new THREE.MeshStandardMaterial({
      map: tex,
      roughness: 0.6,
      metalness: 0.1,
    });
  }

  if (wireframe) {
    mesh.material.wireframe = true;
  }
}

// Swap texture on current model
async function swapTexture(palette) {
  if (!currentModel) return;
  currentPalette = palette;
  const tex = await loadTexture(ASSET_BASE + palette.file);

  currentModel.traverse((child) => {
    if (child.isMesh && child.visible && child.material && child.material.map) {
      child.material.map = tex;
      child.material.needsUpdate = true;
    }
  });

  updateSwatchActive();
}

// Controls
window.resetCamera = function() {
  if (currentModel) {
    const box = new THREE.Box3();
    currentModel.traverse((c) => { if (c.isMesh && c.visible) box.expandByObject(c); });
    if (!box.isEmpty()) {
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());
      controls.target.copy(center);
      const maxDim = Math.max(size.x, size.y, size.z);
      camera.position.set(center.x + maxDim * 1.2, center.y + maxDim * 0.3, center.z + maxDim * 1.2);
      controls.update();
    }
  }
};

window.toggleWireframe = function() {
  wireframe = !wireframe;
  document.getElementById('wireframeBtn').classList.toggle('active', wireframe);
  if (currentModel) {
    currentModel.traverse((child) => {
      if (child.isMesh && child.material) {
        child.material.wireframe = wireframe;
      }
    });
  }
};

window.toggleRotation = function() {
  autoRotate = !autoRotate;
  controls.autoRotate = autoRotate;
  document.getElementById('rotateBtn').classList.toggle('active', autoRotate);
};

// Build sidebar
function buildCharList(filter = 'all', search = '') {
  const list = document.getElementById('charList');
  list.innerHTML = '';

  const filtered = characters.filter(c => {
    if (filter !== 'all' && c.category !== filter) return false;
    if (search && !c.name.toLowerCase().includes(search.toLowerCase())) return false;
    return true;
  });

  filtered.forEach(char => {
    const li = document.createElement('li');
    if (selectedChar && selectedChar.id === char.id) li.classList.add('active');

    li.innerHTML = `
      <span class="char-name">${char.name}</span>
      <span class="char-type">${char.meshes[0]}</span>
      <div class="char-tags">
        ${char.tags.map(t => `<span class="tag tag-${t}">${t}</span>`).join('')}
      </div>
    `;

    li.addEventListener('click', () => selectCharacter(char));
    list.appendChild(li);
  });
}

// Build texture swatches
function buildSwatches() {
  const container = document.getElementById('textureSwatches');
  container.innerHTML = '';

  palettes.forEach(p => {
    const wrapper = document.createElement('div');
    wrapper.style.textAlign = 'center';

    const div = document.createElement('div');
    div.className = `swatch ${p.id === currentPalette.id ? 'active' : ''}`;
    div.style.backgroundImage = `url(${ASSET_BASE + p.file})`;
    div.title = `${p.label}: ${p.desc}`;
    div.dataset.id = p.id;
    div.addEventListener('click', () => swapTexture(p));

    const label = document.createElement('div');
    label.className = 'swatch-label';
    label.textContent = p.label;

    wrapper.appendChild(div);
    wrapper.appendChild(label);
    container.appendChild(wrapper);
  });
}

function updateSwatchActive() {
  document.querySelectorAll('.swatch').forEach(s => {
    s.classList.toggle('active', s.dataset.id === currentPalette.id);
  });
}

// Select character
async function selectCharacter(char) {
  selectedChar = char;

  // Update sidebar active state
  document.querySelectorAll('.char-list li').forEach((li, i) => {
    const filteredChars = characters.filter(c => {
      const filter = document.getElementById('categoryFilter').value;
      const search = document.getElementById('searchInput').value;
      if (filter !== 'all' && c.category !== filter) return false;
      if (search && !c.name.toLowerCase().includes(search.toLowerCase())) return false;
      return true;
    });
    li.classList.toggle('active', filteredChars[i] && filteredChars[i].id === char.id);
  });

  // Update detail panel
  const detail = document.getElementById('detailPanel');
  detail.innerHTML = `
    <h2>${char.name}</h2>
    <div class="detail-grid">
      <div class="detail-section">
        <h3>Description</h3>
        <p>${char.description}</p>
      </div>
      <div class="detail-section">
        <h3>Meshes Included</h3>
        <ul class="mesh-list">
          ${char.meshes.map(m => `<li>${m}</li>`).join('')}
        </ul>
      </div>
      <div class="detail-section">
        <h3>File Info</h3>
        <p>
          <strong>FBX:</strong> ${char.fbx}<br>
          <strong>Default Material:</strong> ${char.material}<br>
          <strong>Category:</strong> ${char.category}<br>
          ${char.gender ? `<strong>Gender:</strong> ${char.gender}<br>` : ''}
          ${char.accessories.length ? `<strong>Accessories:</strong> ${char.accessories.join(', ')}` : ''}
        </p>
      </div>
    </div>
  `;

  // Load 3D model
  await loadCharacter(char);
}

// Event listeners
document.getElementById('categoryFilter').addEventListener('change', (e) => {
  buildCharList(e.target.value, document.getElementById('searchInput').value);
});

document.getElementById('searchInput').addEventListener('input', (e) => {
  buildCharList(document.getElementById('categoryFilter').value, e.target.value);
});

// Init
initViewer();
buildCharList();
buildSwatches();
</script>
</body>
</html>
